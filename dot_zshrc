#!/usr/bin/env zsh
# ~/.zshrc - Zsh configuration

# -----------------------------
# Load unified shell modules
# -----------------------------
[ -f ~/.shell/exports.sh ] && source ~/.shell/exports.sh
[ -f ~/.shell/aliases.sh ] && source ~/.shell/aliases.sh
[ -f ~/.shell/functions.sh ] && source ~/.shell/functions.sh
[ -f ~/.shell/local.sh ] && source ~/.shell/local.sh

# -----------------------------
# Zsh-specific settings
# -----------------------------

# History settings
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_IGNORE_SPACE
setopt HIST_FIND_NO_DUPS
setopt HIST_SAVE_NO_DUPS
setopt HIST_BEEP
setopt SHARE_HISTORY

# -----------------------------
# Zinit Plugin Manager Setup
# -----------------------------

# Install Zinit if not present
if [[ ! -f "$HOME/.zinit/bin/zinit.zsh" ]]; then
    echo "âš¡ Installing Zinit (Zsh plugin manager)..."
    mkdir -p "$HOME/.zinit" && git clone https://github.com/zdharma-continuum/zinit.git "$HOME/.zinit/bin"
fi
source "$HOME/.zinit/bin/zinit.zsh"

# -----------------------------
# Key Bindings
# -----------------------------

# History search with up/down arrows
bindkey '^[[A' history-search-backward
bindkey '^[[B' history-search-forward

# Word navigation
bindkey '^[[1;5C' forward-word
bindkey '^[[1;5D' backward-word
bindkey '^H' backward-kill-word
bindkey '^U' backward-kill-line
bindkey '^L' clear-screen
bindkey '^[q' kill-whole-line
bindkey -M viins '^[[Z' reverse-menu-complete

# Emacs-like bindings
bindkey '^A' beginning-of-line
bindkey '^E' end-of-line
bindkey '^K' kill-line
bindkey '^R' history-incremental-search-backward

# -----------------------------
# Completion System
# -----------------------------

autoload -Uz compinit && compinit

# Completion styling
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LS_COLORS}"
zstyle ':completion:*' special-dirs true

# -----------------------------
# Zsh Plugins (via Zinit)
# -----------------------------

# Syntax highlighting
zinit light zsh-users/zsh-syntax-highlighting

# Autosuggestions
zinit light zsh-users/zsh-autosuggestions

# Fuzzy finder integration
zinit light Aloxaf/fzf-tab

# Additional completions
zinit light zsh-users/zsh-completions

# Enhanced directory navigation
zinit light rupa/z

# Fast syntax highlighting
zinit ice wait lucid atload"alias gst='git status'"
zinit light zdharma-continuum/fast-syntax-highlighting

# History search
zinit light zdharma-continuum/history-search-multi-word

# FZF plugins
if command -v fzf &>/dev/null; then
    zinit light junegunn/fzf
    zinit light junegunn/fzf-git.sh
fi

# -----------------------------
# Tool Initializations
# -----------------------------

# Starship prompt
if command -v starship &>/dev/null; then
    eval "$(starship init zsh)"
fi
# FZF integration
if command -v fzf &>/dev/null; then
    eval "$(fzf --zsh)"
fi

# Zoxide integration
if command -v zoxide &>/dev/null; then
    eval "$(zoxide init zsh --cmd cd)"
    
    # Zoxide-specific aliases for zsh
    alias z='zoxide query --exclude "$(pwd)"'
    alias zi='zoxide query --interactive'
    alias za='zoxide add'
    alias zr='zoxide remove'
    alias zri='zoxide remove --interactive'
fi

# -----------------------------
# Scripts directory setup
# -----------------------------
if [ -d "$HOME/.scripts" ]; then
    find "$HOME/.scripts" -type f -not -perm -u+x -exec chmod +x {} \;
fi

# Remove duplicate PATH entries (zsh-specific)
typeset -U PATH

# -----------------------------
# Welcome message
# -----------------------------
if command -v fastfetch &>/dev/null; then
    fastfetch
fi
